const path=require("path"),async=require("async"),ClassCore=require(path.join(__dirname,"..","..","core","ClassCore.js")),mysql=require(path.join(__dirname,"..","..","config","db.js"));module.exports=class s extends ClassCore{getSMS(s,e){const t=s.params.id;mysql.query("SELECT sn.id as idsms, sn.number, s.at AS sentdate, s.content FROM scheduleds_numbers sn INNER JOIN scheduleds s ON s.id = sn.id_scheduled WHERE ?",{"sn.id":t.toString()},(s,n)=>{if(s)return e.status(500).send(`Erreur Get1 : ${s}`);if(n&&n.length>0){const s=n[0];return s.status="4",e.status(200).json(s)}mysql.query("SELECT se.id_sms AS idsms, se.at AS sentdate, se.target, se.content, se.delivered, se.failed FROM sendeds se WHERE ?",{"se.id_sms":t.toString()},(s,n)=>{if(s)return e.status(500).send(`Erreur Get2 : ${s}`);if(n&&n.length>0){const s=n[0];return 1===s.delivered?s.status="0":1===s.failed&&(s.status="2"),e.status(200).json(s)}const d={};d.idsms=t.toString(),d.status="8",e.status(200).json(d)})})}deleteSMS(s,e){const t=s.params.id;mysql.query("SELECT id_scheduled FROM scheduleds_numbers sn WHERE ?",{"sn.id":t},(s,n)=>{if(s)return e.status(500).send(`Erreur D1 : ${s}`);if(!(n&&n.length>0))return e.status(500).send("No SMS");{const s=n[0].id_scheduled,d="SELECT COUNT(*) as COUNT FROM scheduleds_numbers sn WHERE ?";mysql.query(d,{"sn.id_scheduled":s},(n,d)=>{if(n)return e.status(500).send(`Erreur D2 : ${n}`);let u,i;switch(d[0].COUNT){case 0:return e.status(200).send("SMS Inexistant");case 1:u="DELETE FROM scheduleds_numbers WHERE id = ?; DELETE FROM scheduleds WHERE id = ?",i=[t,s];break;default:u="DELETE FROM scheduleds_numbers WHERE ?",i={id:t}}mysql.query(u,i,s=>{return s?e.status(500).send(`Erreur D3 : ${s}`):e.status(200).send("SMS SupprimÃ©")})})}})}getTag(s,e){const t=s.params.tag,n=[];mysql.query("SELECT sn.id FROM scheduleds_numbers sn INNER JOIN scheduleds s ON s.id = sn.id_scheduled WHERE s.tag = ? UNION SELECT se.id_scheduled FROM sendeds se WHERE se.tag = ?",[t,t],(s,t)=>{if(s)return e.status(500).send(`Erreur Tag1 : ${s}`);async.each(t,(s,e)=>{n.push(s.id),e()},s=>{return s?e.status(500).send(`Erreur Tag1 : ${s}`):e.status(200).send(n)})})}};